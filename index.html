<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic iCal Generator</title>
    
    <!-- Download Tracking -->
    <script>
        // Function to track downloads using Netlify Functions
        async function trackDownload(eventTitle, downloadType) {
            try {
                const response = await fetch('/.netlify/functions/track-download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        eventTitle: eventTitle,
                        downloadType: downloadType
                    })
                });
                
                const result = await response.json();
                console.log('‚úÖ Tracked download:', eventTitle, downloadType, result);
                
                // Also track in localStorage for immediate feedback
                let downloads = JSON.parse(localStorage.getItem('downloadHistory') || '[]');
                downloads.push({
                    timestamp: new Date().toISOString(),
                    eventTitle: eventTitle,
                    downloadType: downloadType
                });
                localStorage.setItem('downloadHistory', JSON.stringify(downloads));
                
            } catch (error) {
                console.error('‚ùå Failed to track download:', error);
                // Fallback to localStorage only
                let downloads = JSON.parse(localStorage.getItem('downloadHistory') || '[]');
                downloads.push({
                    timestamp: new Date().toISOString(),
                    eventTitle: eventTitle,
                    downloadType: downloadType
                });
                localStorage.setItem('downloadHistory', JSON.stringify(downloads));
            }
        }
        
        // Function to view stats (for testing)
        function viewStats() {
            window.open('/.netlify/functions/get-stats', '_blank');
        }
    </script>
    
    <style>
        body {
            font-family: "Avenir Next LT Pro", "Calibri", -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 50%, #f59e0b 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 48px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        h1 {
            color: #000000;
            text-align: center;
            margin-bottom: 32px;
            font-size: 2.8em;
            font-weight: 700;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input, textarea, select {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            background: #fafafa;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
            background: white;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .time-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        button {
            background: linear-gradient(135deg, #8b5cf6, #ec4899, #f59e0b);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 24px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(139, 92, 246, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .share-box {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .share-url {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            margin: 10px 0;
            min-height: 60px;
        }
        .copy-btn {
            background: #28a745;
            padding: 8px 16px;
            font-size: 14px;
            margin: 5px;
        }
        .info {
            background: rgba(139, 92, 246, 0.1);
            border-left: 4px solid #8b5cf6;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .text-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
            padding: 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 14px;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ Dynamic iCal Generator</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('create')">Create Event</button>
            <button class="tab" onclick="switchTab('download')">Download Link</button>
        </div>

        <div id="create-tab" class="tab-content active">
            <div class="info">
                <strong>Create a shareable iCal:</strong> Fill out the form and generate a link that others can click to download the event starting from their current date.
            </div>

            <form id="eventForm">
                <div class="form-group">
                    <label for="eventTitle">Event Title:</label>
                    <input type="text" id="eventTitle" value="Weekly Team Meeting" required>
                </div>

                <div class="form-group">
                    <label for="eventDescription">Event Description:</label>
                    <textarea id="eventDescription" placeholder="Enter event details, agenda, location, etc.">Weekly team sync to discuss project progress, blockers, and upcoming deliverables.</textarea>
                    <div class="text-warning">
                        <strong>üìù Note:</strong> Keep descriptions simple! Line breaks, tables, and special formatting don't work in calendar events. Stick to plain text only.
                    </div>
                </div>

                <div class="form-group">
                    <label for="eventLocation">Location:</label>
                    <input type="text" id="eventLocation" placeholder="Conference Room A, Zoom link, etc." value="Conference Room A">
                </div>

                <div class="time-group">
                    <div class="form-group">
                        <label for="startTime">Start Time:</label>
                        <input type="time" id="startTime" value="10:00" required>
                    </div>
                    <div class="form-group">
                        <label for="endTime">End Time:</label>
                        <input type="time" id="endTime" value="11:00" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="occurrences">Number of Occurrences:</label>
                    <select id="occurrences">
                        <option value="4" selected>4 weeks</option>
                        <option value="6">6 weeks</option>
                        <option value="8">8 weeks</option>
                        <option value="12">12 weeks</option>
                    </select>
                </div>

                <button type="submit">üîó Generate Shareable Link</button>
            </form>

            <div class="share-box" id="shareBox" style="display: none;">
                <h3>üì§ Share This Link</h3>
                <p>Anyone who clicks this link will download the iCal file with events starting from their current date:</p>
                <div class="share-url" id="shareUrl"></div>
                <button class="copy-btn" onclick="copyToClipboard()">üìã Copy Link</button>
                <br>
                <a id="testDownload" class="download-btn" target="_blank">üß™ Test Download</a>
            </div>
        </div>
    </div>

    <script>
        function formatDate(date) {
            return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        }

        function generateICalContent(eventData) {
            const now = new Date();
            const startDate = new Date(now);
            const endDate = new Date(now);
            
            // Set start time to current hour (dynamic!)
            startDate.setMinutes(0, 0, 0); // Set to top of current hour
            
            // Calculate end time based on form duration
            const [formStartHour, formStartMin] = eventData.startTime.split(':');
            const [formEndHour, formEndMin] = eventData.endTime.split(':');
            
            const formStartMinutes = parseInt(formStartHour) * 60 + parseInt(formStartMin);
            const formEndMinutes = parseInt(formEndHour) * 60 + parseInt(formEndMin);
            const durationMinutes = formEndMinutes - formStartMinutes;
            
            // Set end time to current hour + duration from form
            endDate.setTime(startDate.getTime() + (durationMinutes * 60 * 1000));
            
            const uid = 'event-' + Date.now() + '@dynamic-ical-generator';
            const created = formatDate(now);
            const dtstart = formatDate(startDate);
            const dtend = formatDate(endDate);
            
            let icalContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Dynamic iCal Generator//EN
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${created}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${eventData.title}
DESCRIPTION:${eventData.description}`;

            if (eventData.location) {
                icalContent += `\nLOCATION:${eventData.location}`;
            }

            icalContent += `
RRULE:FREQ=WEEKLY;COUNT=${eventData.occurrences}
END:VEVENT
END:VCALENDAR`;

            return icalContent;
        }

        function downloadICalFile(content, filename) {
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename || 'event.ics';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        function getEventDataFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('title')) {
                return {
                    title: decodeURIComponent(urlParams.get('title')),
                    description: decodeURIComponent(urlParams.get('description') || ''),
                    location: decodeURIComponent(urlParams.get('location') || ''),
                    startTime: urlParams.get('startTime') || '10:00',
                    endTime: urlParams.get('endTime') || '11:00',
                    occurrences: urlParams.get('occurrences') || '4'
                };
            }
            return null;
        }

        function createShareableURL(eventData) {
            const baseURL = window.location.origin + window.location.pathname;
            const params = new URLSearchParams({
                title: eventData.title,
                description: eventData.description,
                location: eventData.location,
                startTime: eventData.startTime,
                endTime: eventData.endTime,
                occurrences: eventData.occurrences,
                download: 'auto'
            });
            return `${baseURL}?${params.toString()}`;
        }

        function copyToClipboard() {
            const shareUrl = document.getElementById('shareUrl').textContent;
            navigator.clipboard.writeText(shareUrl).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#28a745';
                }, 2000);
            });
        }

        function updatePreview(eventData) {
            const icalContent = generateICalContent(eventData);
            document.getElementById('previewContent').textContent = icalContent;
            document.getElementById('preview').style.display = 'block';
        }

        // Check if this is an auto-download link
        const urlEventData = getEventDataFromURL();
        const urlParams = new URLSearchParams(window.location.search);

        if (urlEventData && urlParams.get('download') === 'auto') {
            // Switch to download tab
            switchTab('download');
            
            // Show event details
            const today = new Date().toLocaleDateString();
            const currentHour = new Date().getHours();
            const timeDisplay = `${currentHour.toString().padStart(2, '0')}:00`;
            
            document.getElementById('eventDetails').innerHTML = `
                <strong>üìÖ ${urlEventData.title}</strong><br>
                <strong>üìç Location:</strong> ${urlEventData.location}<br>
                <strong>üïí Starting:</strong> Today at ${timeDisplay} (duration from form: ${urlEventData.startTime} - ${urlEventData.endTime})<br>
                <strong>üîÑ Repeats:</strong> Weekly for ${urlEventData.occurrences} weeks<br>
                <strong>üìÜ First occurrence:</strong> ${today}<br><br>
                <em>${urlEventData.description}</em>
            `;
            
            // Auto download after 2 seconds
            setTimeout(() => {
                const icalContent = generateICalContent(urlEventData);
                const filename = urlEventData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.ics';
                trackDownload(urlEventData.title, 'auto_download');
                downloadICalFile(icalContent, filename);
            }, 2000);
            
            // Manual download button
            document.getElementById('manualDownload').addEventListener('click', () => {
                const icalContent = generateICalContent(urlEventData);
                const filename = urlEventData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.ics';
                trackDownload(urlEventData.title, 'manual_download');
                downloadICalFile(icalContent, filename);
            });
        }

        function copyToClipboard() {
            const shareUrl = document.getElementById('shareUrl').textContent;
            navigator.clipboard.writeText(shareUrl).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#28a745';
                }, 2000);
            });
        }

        // Check if this is a direct download link
        const urlEventData = getEventDataFromURL();
        const urlParams = new URLSearchParams(window.location.search);

        if (urlEventData && urlParams.get('download') === 'auto') {
            // Auto download immediately
            setTimeout(() => {
                const icalContent = generateICalContent(urlEventData);
                const filename = urlEventData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.ics';
                trackDownload(urlEventData.title, 'auto_download');
                downloadICalFile(icalContent, filename);
            }, 1000);
        }

        // Form submission handler
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const eventData = {
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                location: document.getElementById('eventLocation').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                occurrences: document.getElementById('occurrences').value
            };

            // Generate shareable URL
            const shareableURL = createShareableURL(eventData);
            document.getElementById('shareUrl').textContent = shareableURL;
            document.getElementById('testDownload').href = shareableURL;
            document.getElementById('shareBox').style.display = 'block';
            
            // Show success message
            const button = document.querySelector('button[type="submit"]');
            const originalText = button.textContent;
            button.textContent = '‚úÖ Link Generated!';
            button.style.background = 'linear-gradient(45deg, #10b981, #20c997)';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = 'linear-gradient(135deg, #8b5cf6, #ec4899, #f59e0b)';
            }, 2000);
        });

        // Update preview when form changes (only if not auto-download mode)
        if (!urlEventData) {
            document.getElementById('eventForm').addEventListener('input', () => {
                const eventData = {
                    title: document.getElementById('eventTitle').value,
                    description: document.getElementById('eventDescription').value,
                    location: document.getElementById('eventLocation').value,
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value,
                    occurrences: document.getElementById('occurrences').value
                };
                updatePreview(eventData);
            });
            
            // Initialize preview
            updatePreview({
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                location: document.getElementById('eventLocation').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                occurrences: document.getElementById('occurrences').value
            });
        }
    </script>
</body>
</html>
